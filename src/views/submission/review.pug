include ../header.pug
include ../mixins/submissionImages.pug
include ../mixins/submissionVideo.pug
include ../mixins/caresBadge.pug
include ../mixins/iucnBadge.pug
include ../mixins/emptyState.pug

mixin reviewTextInput(labelText, name, type="text")
    .grid.gap-2
        label.input-label(for=name)= labelText
        input.text-input(
            disabled
            id=name
            value=submission[name]
            name=name
            type=type)

doctype html
html
    +headTag(`${canonicalName} - BAS BAP`, ogData)

    body.bg-white.text-gray-800
        +pageHeader(isLoggedIn, canonicalName, submission.member_name)

        section.bg-gray-100.py-4

            div.max-w-4xl.mx-auto.text-left.pt-4.px-4
                h2(class="text-l font-bold pt-2 mb-4") Member Details
                div.grid.grid-cols-1.w-full.gap-2(class="md:grid-cols-2")
                    +reviewTextInput("Member Name", "member_name")

            div.max-w-4xl.mx-auto.text-left.pt-4.px-4
                .flex.items-center.gap-2.mb-4
                    h2(class="text-l font-bold") Species Details
                    if name && name.is_cares_species == 1
                        +caresBadge('sm')
                    if name && name.iucn_redlist_category
                        +iucnBadge(name.iucn_redlist_category, 'sm', false, true, name.iucn_redlist_url)
                    if name && name.iucn_population_trend
                        +populationTrend(name.iucn_population_trend, 'sm')
                div.grid.grid-cols-1.w-full.gap-2(class="md:grid-cols-2")
                    +reviewTextInput("Common Name", "species_common_name")
                    +reviewTextInput("Latin Name", "species_latin_name")
                    +reviewTextInput("Spawn Date", "reproduction_date")
                    +reviewTextInput("# of Fry", "count")

                    +reviewTextInput("Species Type", "species_type")
                    +reviewTextInput("Species Class", "species_class")
                    +reviewTextInput("Water Type", "water_type")

                    +reviewTextInput("Foods", "foods")
                    +reviewTextInput("Spawn Locations", "spawn_locations")

            div.max-w-4xl.mx-auto.text-left.pt-4.px-4
                +submissionImages(submission.images, 'gallery')
                +submissionVideo(submission.video_url, videoMetadata)

                if submission.article_link
                    div.mb-6
                        h3.text-lg.font-bold.mb-3.text-gray-900 Breeding Article
                        a.text-blue-600.hover_text-blue-800.hover_underline.break-all(
                            href=submission.article_link
                            target="_blank"
                            rel="noopener noreferrer"
                        )= submission.article_link

            div.max-w-4xl.mx-auto.text-left.pt-4.px-4
                h2(class="text-l font-bold pt-2 mb-4") Tank Details
                div.grid.grid-cols-1.w-full.gap-2(class="md:grid-cols-2")
                    +reviewTextInput("Tank Size", "tank_size")
                    +reviewTextInput("Filter Type", "filter_type")
                    +reviewTextInput("Water Change Volume (%)", "water_change_volume")
                    +reviewTextInput("Water Change Frequency", "water_change_frequency")
                    +reviewTextInput("Temperature", "temperature")
                    +reviewTextInput("pH", "ph")
                    +reviewTextInput("Hardness (GH)", "gh")
                    +reviewTextInput("Specific Gravity", "specific_gravity")
                    +reviewTextInput("Substrate Type", "substrate_type")
                    +reviewTextInput("Substrate Depth", "substrate_depth")
                    +reviewTextInput("Substrate Color", "substrate_color")


            div.max-w-4xl.mx-auto.text-left.px-4.pb-6
                h2(class="text-l font-bold mb-4") Approval Details
                div.grid.grid-cols-1.w-full.gap-2(class="md:grid-cols-2")
                    +reviewTextInput("Submitted On", "submitted_on")
                    +reviewTextInput("Witnessed", "witnessed")
                    +reviewTextInput("Approved", "approved")
                    +reviewTextInput("Points", "points")
                    +reviewTextInput("Total Points", "total_points")

        // Dialog container for edit approved submission modal
        if isAdmin && isApproved && !isSelf
            dialog#edit-approved-dialog(
                class="rounded-lg shadow-xl"
                style="max-width: 900px; width: 90%; max-height: 90vh; padding: 0; border: none; margin: auto;"
            )

            script.
                // Initialize Tom Select for edit approved submission form
                function initEditFormMultiSelects() {
                    document.querySelectorAll("#edit-approved-dialog select.tom-select-multi").forEach((select) => {
                        if (select.tomselect) {
                            select.tomselect.destroy();
                        }

                        new TomSelect(select, {
                            hideSelected: true,
                            create: true,
                        });
                    });
                }

                function initEditFormTypeaheads() {
                    const typeaheadElements = document.querySelectorAll('#edit-approved-dialog select.tom-select-typeahead:not(.tomselected)');
                    typeaheadElements.forEach(function(element) {
                        const config = getTypeaheadConfig(element);
                        const tomSelectOptions = buildTomSelectOptions(element, config);
                        const tomSelect = new TomSelect(element, tomSelectOptions);
                        element.tomSelectInstance = tomSelect;
                        if (config.maxItems === 1) {
                            tomSelect.control.classList.add('single-value');
                        }
                        element.classList.add('tomselected');
                    });
                }

                // Listen for HTMX content loads
                document.addEventListener("htmx:load", function (event) {
                    const target = event.detail.elt;
                    // Reinitialize when dialog content is loaded
                    if (target && target.closest && target.closest('#edit-approved-dialog')) {
                        initEditFormMultiSelects();
                        initEditFormTypeaheads();
                    }
                });

            style.
                #edit-approved-dialog::backdrop {
                    background-color: rgba(0, 0, 0, 0.5);
                }

        // Member Edit Section - for unsubmitted submissions
        if isSelf && !isApproved
            section.bg-gray-100.py-6
                div.max-w-4xl.mx-auto.text-center.px-4
                    form.inline(hx-patch=`/submissions/${submission.id}`)
                        button.primary(name="unsubmit" type="submit") Edit Submission

        // Owner action buttons section
        if isSelf
            section.bg-gray-100.pb-6
                div.max-w-4xl.mx-auto.text-center.px-4
                    .flex.justify-center.gap-4
                        // Edit Media button - only for approved submissions
                        if isApproved
                            a.primary(
                                class="px-4 py-2 text-sm"
                                href=`/submissions/${submission.id}/edit-media`
                            ) Edit Photos & Video

                        // Delete button
                        button.destructive(
                            class="px-4 py-2 text-sm"
                            hx-delete=`/submissions/${submission.id}`
                            hx-confirm="Are you sure you want to permanently delete this submission? This cannot be undone."
                            type="button"
                        ) Delete

        // Unified Admin Section (action panels + notes + edit button)
        if isAdmin
            section.bg-gray-100
                // Screening Actions Panel - only show for pending screening
                if submission.witness_verification_status === 'pending'
                    if isSelf
                        // Show message for self-screening case
                        .status-panel.status-panel-warning
                            .container.mx-auto.max-w-4xl
                                h3.text-yellow-800.text-lg.font-semibold.mb-2 ðŸ“‹ Admin Screening Needed
                                - const speciesText = submission.species_type === 'Plant' || submission.species_type === 'Coral' ? 'propagation' : 'spawn'
                                p.text-yellow-700.mb-2= `Your ${speciesText} needs to be screened by a different program admin for completeness.`
                                p.text-yellow-600.text-sm You cannot screen your own submissions. Please contact another admin to review this submission.
                    else
                        // Show screening action buttons for other admins
                        .status-panel.status-panel-admin#witnessPanel
                            .container.mx-auto.max-w-4xl
                                h3.text-white.text-lg.font-semibold.mb-4 Admin Screening Required
                                p.text-white.mb-4 Review the submission details above, including any photos/videos (when available), for completeness and credibility.
                                div.flex.justify-center.max-w-4xl.mx-auto.text-center.gap-4
                                    form(hx-post=`/admin/submissions/${submission.id}/confirm-witness`)
                                        - const actionText = submission.species_type === 'Plant' ? 'Approve for Screening' : 'Approve for Screening'
                                        button.primary(type="submit")= actionText

                                    button.destructive(
                                        type="button"
                                        hx-get=`/admin/dialog/submissions/${submission.id}/decline-witness`
                                        hx-target="closest body"
                                        hx-swap="beforeend") Request More Info

                // Show auction eligibility status for screened submissions
                if submission.witness_verification_status === 'confirmed' && !isApproved
                    if !waitingPeriodStatus.eligible
                        // Show auction eligibility countdown
                        .status-panel.status-panel-pending
                            .container.mx-auto.max-w-4xl
                                h3.text-blue-800.text-lg.font-semibold.mb-2 â³ Awaiting Auction Eligibility
                                - const speciesText = submission.species_type === 'Plant' || submission.species_type === 'Coral' ? 'propagation' : 'spawn'
                                - const offspringText = submission.species_type === 'Plant' ? 'plants' : submission.species_type === 'Coral' ? 'corals' : 'fry'
                                p.text-blue-700.mb-2= `This ${speciesText} has been screened. Bring ${offspringText} to a monthly auction after ${waitingPeriodStatus.requiredDays} days.`
                                .bg-blue-100.rounded.p-3.mt-2
                                    p.text-blue-800.font-semibold Days until eligible for auction: #{waitingPeriodStatus.daysRemaining}
                                    p.text-blue-600.text-sm.mt-1 Elapsed: #{waitingPeriodStatus.elapsedDays} of #{waitingPeriodStatus.requiredDays} days

                        // Admin actions panel during waiting period
                        if isAdmin && !isSelf
                            .status-panel.status-panel-admin
                                .container.mx-auto.max-w-4xl
                                    h3.text-white.text-lg.font-semibold.mb-4 Admin Actions
                                    p.text-white.mb-4 While awaiting auction eligibility, you can request changes or delete this submission.
                                    .flex.justify-center.gap-4
                                        button.destructive(
                                            type="button"
                                            hx-get=`/admin/dialog/submissions/${submission.id}/request-changes`
                                            hx-target="closest body"
                                            hx-swap="beforeend"
                                        ) Request Changes
                                        button.destructive(
                                            type="button"
                                            hx-delete=`/submissions/${submission.id}`
                                            hx-confirm="Are you sure you want to permanently delete this submission? This cannot be undone."
                                        ) Delete
                    else if isSelf
                        // Show message for self-approval prevention
                        .status-panel.status-panel-warning
                            .container.mx-auto.max-w-4xl
                                h3.text-yellow-800.text-lg.font-semibold.mb-2 âœ… Ready for Points Award
                                - const speciesText = submission.species_type === 'Plant' || submission.species_type === 'Coral' ? 'propagation' : 'spawn'
                                - const offspringText = submission.species_type === 'Plant' ? 'plants' : submission.species_type === 'Coral' ? 'corals' : 'fry'
                                p.text-yellow-700.mb-2= `Your ${speciesText} is auction-eligible. Bring ${offspringText} to the next meeting to receive points!`
                                p.text-yellow-600.text-sm You cannot award points to your own submissions. Please contact another admin at the meeting to complete the award process.
                    else
                        // Show approval panel for other admins
                        .status-panel.status-panel-admin#adminPanel
                            include ../admin/approvalPanel.pug

            // Admin Notes and Actions - shown after action panels
            section.bg-gray-700.py-6
                div.max-w-4xl.mx-auto.text-left.px-4
                    h2.text-xl.font-bold.mb-2.text-white Admin Section
                    p.text-sm.text-gray-300.mb-4 Private notes and actions visible only to program admins

                    // Edit Approved Submission button (for approved submissions only)
                    if isApproved && !isSelf
                        div.mb-6
                            button.primary(
                                type="button"
                                onclick="document.getElementById('edit-approved-dialog').showModal()"
                                hx-get=`/admin/submissions/${submission.id}/edit-approved`
                                hx-target="#edit-approved-dialog"
                                hx-swap="innerHTML"
                            ) Edit Approved Submission

                    // Notes subsection
                    div.mt-6
                        h3.text-lg.font-semibold.text-white.mb-2 Notes

                        //- Notes feed
                        div#notes-list.mb-6.space-y-3
                            if adminNotes && adminNotes.length > 0
                                each note in adminNotes
                                    include ../admin/submissionNote.pug
                            else
                                +emptyState("No notes yet", { size: "sm" })

                        //- Note form
                        form#note-form(
                            hx-post=`/admin/submissions/${submission.id}/notes`
                            hx-target="#notes-list"
                            hx-swap="beforeend"
                            hx-on--after-request="this.reset()"
                        )
                            div.mb-2
                                textarea.text-input(
                                    id="note_text"
                                    name="note_text"
                                    placeholder="Write a note..."
                                    rows="3"
                                    required
                                    maxlength="2000"
                                )
                            button.primary(type="submit") Add Note

        // Initialize typeahead for species selection in approval panel
        if isAdmin
            style.
                /* Force typeahead to maintain fixed width and handle long text */
                .ts-wrapper.species-search-wrapper {
                    width: 400px !important;
                    min-width: 400px !important;
                    max-width: 400px !important;
                }
                .ts-wrapper.species-search-wrapper .ts-control {
                    width: 100% !important;
                }
                /* Handle long text in selected items */
                .ts-wrapper.species-search-wrapper .ts-control.single-value .item {
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: nowrap !important;
                    max-width: calc(100% - 40px) !important;
                    display: block !important;
                }
                /* Hide input when item is selected (has-items class) */
                .ts-wrapper.species-search-wrapper.has-items .ts-control input {
                    width: 0 !important;
                    padding: 0 !important;
                    margin: 0 !important;
                    opacity: 0 !important;
                }

            script.
                function initializeTypeaheads() {
                    const typeaheadElements = document.querySelectorAll('select.tom-select-typeahead:not(.tomselected)');
                    typeaheadElements.forEach(function(element) {
                        const config = getTypeaheadConfig(element);
                        const tomSelectOptions = buildTomSelectOptions(element, config);
                        const tomSelect = new TomSelect(element, tomSelectOptions);
                        element.tomSelectInstance = tomSelect;

                        if (config.maxItems === 1) {
                            tomSelect.control.classList.add('single-value');
                        }

                        // Add wrapper class for species search to maintain fixed width
                        if (element.id === 'species-search') {
                            tomSelect.wrapper.classList.add('species-search-wrapper');
                        }
                    });
                }

                document.addEventListener('DOMContentLoaded', function() {
                    initializeTypeaheads();
                });
