include ../header.pug
include adminNav.pug
include ../mixins/emptyState.pug
include ../mixins/iucnBadge.pug
include ../mixins/hoverCard.pug

- const stringCell = ['p-3', 'text-left', 'border-b', 'border-gray-200'];
- const heading = ['p-3', 'text-left', 'font-bold', 'text-gray-900', 'border-b-2', 'border-gray-300', 'bg-gray-50', 'cursor-pointer', 'select-none', 'hover:bg-gray-100'];
- const numberHeading = ['p-3', 'text-right', 'font-bold', 'text-gray-900', 'border-b-2', 'border-gray-300', 'bg-gray-50', 'cursor-pointer', 'select-none', 'hover:bg-gray-100'];
- const nonSortableHeading = ['p-3', 'text-left', 'font-bold', 'text-gray-900', 'border-b-2', 'border-gray-300', 'bg-gray-50', 'no-sort'];

mixin speciesTable(speciesList)
  .overflow-x-auto.w-full
    table(data-sortable class="w-full bg-white shadow-sm rounded-lg" id="species-table")
      thead
        tr
          th(class=nonSortableHeading style="width: 40px;")
            input(type="checkbox" id="select-all" class="cursor-pointer" hx-on:change="document.querySelectorAll('.species-checkbox').forEach(cb => cb.checked = this.checked); this.closest('form').dispatchEvent(new Event('change', {bubbles: true}));")
          th(class=heading) Canonical Name
          th(class=heading) Type
          th(class=heading) Class
          th(class=numberHeading data-sort-method="number") Points
          th(class=heading) CARES
          th(class=heading) IUCN Status
          th(class=nonSortableHeading) Actions

      tbody
        each item in speciesList
          tr(class="hover:bg-gray-50")
            td(class=stringCell + ' text-center')
              input(type="checkbox" name="groupIds" value=item.group_id class="species-checkbox cursor-pointer" hx-on:change="this.closest('form').dispatchEvent(new Event('change', {bubbles: true}));")
            td(class=stringCell)
              if item.synonym_count > 0
                +hoverCard({id: `species-${item.group_id}`, side: 'right', width: 'md', openDelay: 300})
                  +hoverCardTrigger()
                    a.link.font-semibold(href=`/admin/species/${item.group_id}/edit`)
                      = `${item.canonical_genus} ${item.canonical_species_name}`
                      span.ml-1.text-xs.text-gray-500.font-normal (#{item.synonym_count})
                  +hoverCardContent({cardClasses: 'hovercard-blue-border'})
                    if item.common_names && item.common_names.length > 0
                      div
                        h4.font-semibold.text-gray-900.mb-1 Common Names
                        ul(class="list-disc list-inside text-sm space-y-0.5")
                          each name in item.common_names
                            li= name

                    if item.scientific_names && item.scientific_names.length > 0
                      div
                        h4.font-semibold.text-gray-900.mb-1 Scientific Names
                        ul(class="list-disc list-inside text-sm space-y-0.5 italic")
                          each name in item.scientific_names
                            li= name

                    if (!item.common_names || item.common_names.length === 0) && (!item.scientific_names || item.scientific_names.length === 0)
                      p.text-sm.text-gray-500.italic No synonyms recorded
              else
                a.link.font-semibold(href=`/admin/species/${item.group_id}/edit`)
                  = `${item.canonical_genus} ${item.canonical_species_name}`

            td(class=stringCell)
              span.inline-block.px-2.py-1.text-xs.font-medium.bg-blue-100.text-blue-800.rounded-full
                = item.species_type

            td(class=stringCell)
              span.inline-block.px-2.py-1.text-xs.font-medium.bg-gray-100.text-gray-800.rounded-full
                = item.program_class

            td(class=stringCell + ' text-right')
              if item.base_points !== null
                span.inline-block.px-2.py-1.text-sm.font-medium.bg-green-100.text-green-800.rounded-full
                  = item.base_points
              else
                span.text-gray-400 â€”

            td(class=stringCell + ' text-center')
              if item.is_cares_species
                span.text-yellow-500(title="CARES Conservation Species") â­
              else
                span.text-gray-300 â˜†

            td(class=stringCell)
              .flex.items-center.gap-1
                +iucnBadgeWithHover(item, item.group_id, 'sm')
                if item.iucn_population_trend && !item.iucn_redlist_category
                  +populationTrend(item.iucn_population_trend, 'sm')

            td(class=stringCell)
              a(
                class="outline text-xs px-3 py-1 inline-block"
                href=`/admin/species/${item.group_id}/edit`
              ) Edit

doctype html
html
  +headTag(title)
    script(src='/tablesort.min.js')
    script(src='/tablesort.number.min.js')
    script.
      document.addEventListener('DOMContentLoaded', function() {
        const tables = document.querySelectorAll('table[data-sortable]');
        tables.forEach(table => {
          new Tablesort(table);
        });
      });

      // Update selection count when checkboxes change (minimal JS)
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bulk-species-form');
        if (form) {
          form.addEventListener('change', function() {
            const checked = document.querySelectorAll('.species-checkbox:checked');
            const count = checked.length;
            const toolbar = document.getElementById('bulk-actions-toolbar');
            const countSpan = document.getElementById('selected-count');

            countSpan.textContent = count;
            toolbar.style.display = count > 0 ? 'block' : 'none';
          });

          // Trigger initial check
          form.dispatchEvent(new Event('change'));
        }
      });

  body.bg-white.text-gray-800
    +pageHeader(true, title)

    section.bg-gray-100.py-6
      div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8")

        //- Quick Links Navigation
        .mb-4.flex.gap-2.justify-end
          a.outline.text-sm.px-3.py-1(href="/admin/species/canonical-recommendations")
            | ðŸ“ IUCN Name Recommendations

        //- Filters Section
        .bg-white.rounded-lg.shadow-md.p-6.mb-6
          form(method="GET" action="/admin/species")
            .grid.grid-cols-1.gap-4(class="md:grid-cols-2 lg:grid-cols-6")

              //- Species Type Filter
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="species_type") Type
                .select-wrapper
                  select#species_type(name="species_type" onchange="this.form.submit()")
                    option(value="" selected=!filters.species_type) All Types
                    each type in speciesTypes
                      option(value=type selected=(filters.species_type === type))= type

              //- Program Class Filter
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="species_class") Class
                .select-wrapper
                  select#species_class(name="species_class" onchange="this.form.submit()")
                    option(value="" selected=!filters.program_class) All Classes
                    each cls in classOptions
                      option(value=cls.value selected=(filters.program_class === cls.value))= cls.text

              //- Points Filter
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="has_points") Points Status
                .select-wrapper
                  select#has_points(name="has_points" onchange="this.form.submit()")
                    option(value="" selected=(filters.has_base_points === undefined)) All Species
                    option(value="true" selected=(filters.has_base_points === true)) With Points
                    option(value="false" selected=(filters.has_base_points === false)) Without Points

              //- CARES Filter
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="is_cares") CARES
                .select-wrapper
                  select#is_cares(name="is_cares" onchange="this.form.submit()")
                    option(value="" selected=(filters.is_cares_species === undefined)) All
                    option(value="true" selected=(filters.is_cares_species === true)) CARES Only
                    option(value="false" selected=(filters.is_cares_species === false)) Non-CARES

              //- IUCN Filter
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="iucn") IUCN Status
                .select-wrapper
                  select#iucn(name="iucn" onchange="this.form.submit()")
                    option(value="" selected=!filters.iucn_category) All
                    option(value="with_data" selected=(filters.iucn_category === 'with_data')) With IUCN Data
                    option(value="missing" selected=(filters.iucn_category === 'missing')) Missing IUCN
                    option(disabled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    option(value="CR" selected=(filters.iucn_category === 'CR')) CR - Critically Endangered
                    option(value="EN" selected=(filters.iucn_category === 'EN')) EN - Endangered
                    option(value="VU" selected=(filters.iucn_category === 'VU')) VU - Vulnerable
                    option(value="NT" selected=(filters.iucn_category === 'NT')) NT - Near Threatened
                    option(value="LC" selected=(filters.iucn_category === 'LC')) LC - Least Concern
                    option(value="DD" selected=(filters.iucn_category === 'DD')) DD - Data Deficient
                    option(value="NE" selected=(filters.iucn_category === 'NE')) NE - Not Evaluated
                    option(value="EW" selected=(filters.iucn_category === 'EW')) EW - Extinct in Wild
                    option(value="EX" selected=(filters.iucn_category === 'EX')) EX - Extinct

              //- Search Input
              .space-y-2
                label.block.text-sm.font-medium.text-gray-700(for="search") Search
                input(
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  type="text"
                  id="search"
                  name="search"
                  placeholder="Name or synonym..."
                  value=(filters.search || "")
                )

            .flex.justify-between.items-center.mt-4
              .flex.gap-2
                button.primary(type="submit") Apply Filters
                if filters.species_type || filters.program_class || filters.has_base_points !== undefined || filters.is_cares_species !== undefined || filters.iucn_category || filters.search
                  a.link(href="/admin/species") Clear Filters

              .text-sm.text-gray-600
                strong= pagination.totalCount
                |  total species

        //- Results Table wrapped in form for bulk actions
        if species && species.length > 0
          form#bulk-species-form
            //- Bulk Actions Toolbar (shown when species are selected via CSS)
            #bulk-actions-toolbar(class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded-lg shadow-md")
              .flex.justify-between.items-center
                .flex.items-center.gap-4
                  span.text-blue-800.font-semibold
                    span#selected-count 0
                    |  species selected
                  button.primary(
                    type="button"
                    hx-get="/admin/dialog/species/bulk-set-points"
                    hx-target="body"
                    hx-swap="beforeend"
                    hx-include="#bulk-species-form"
                  ) Bulk Edit Points
                  button.primary(
                    type="button"
                    hx-post="/admin/species/bulk-sync-iucn"
                    hx-include="#bulk-species-form"
                    hx-target="#bulk-sync-results"
                    hx-swap="innerHTML"
                    hx-indicator="#bulk-sync-indicator"
                  ) Sync IUCN Data
                  button.outline(
                    type="button"
                    hx-on:click="document.querySelectorAll('.species-checkbox').forEach(cb => cb.checked = false); document.getElementById('select-all').checked = false; this.closest('form').dispatchEvent(new Event('change', {bubbles: true}));"
                  ) Clear Selection

                //- Loading indicator for IUCN sync
                #bulk-sync-indicator.htmx-indicator
                  .flex.gap-2.items-center.text-blue-600
                    svg.animate-spin.h-4.w-4(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24")
                      circle.opacity-25(cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4")
                      path.opacity-75(fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")
                    span Syncing...

            //- Results message area for bulk IUCN sync
            #bulk-sync-results

            +speciesTable(species)

          //- Pagination
          - const queryParams = [];
          - if (filters.species_type) queryParams.push(`species_type=${encodeURIComponent(filters.species_type)}`);
          - if (filters.program_class) queryParams.push(`species_class=${encodeURIComponent(filters.program_class)}`);
          - if (filters.has_base_points !== undefined) queryParams.push(`has_points=${filters.has_base_points}`);
          - if (filters.is_cares_species !== undefined) queryParams.push(`is_cares=${filters.is_cares_species}`);
          - if (filters.iucn_category) queryParams.push(`iucn=${encodeURIComponent(filters.iucn_category)}`);
          - if (filters.search) queryParams.push(`search=${encodeURIComponent(filters.search)}`);
          - if (sort !== 'name') queryParams.push(`sort=${sort}`);
          - const baseQuery = queryParams.length > 0 ? '&' + queryParams.join('&') : '';

          if pagination.totalPages > 1
            .mt-6.flex.justify-center.gap-2
              if pagination.currentPage > 1
                a.outline.px-3.py-2(href=`/admin/species?page=${pagination.currentPage - 1}${baseQuery}`) Previous

              .flex.gap-1
                - const startPage = Math.max(1, pagination.currentPage - 2);
                - const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);

                if startPage > 1
                  a.outline.px-3.py-2(href=`/admin/species?page=1${baseQuery}`) 1
                  if startPage > 2
                    span.px-3.py-2.text-gray-400 ...

                - for (let i = startPage; i <= endPage; i++)
                  if i === pagination.currentPage
                    span.primary.px-3.py-2= i
                  else
                    a.outline.px-3.py-2(href=`/admin/species?page=${i}${baseQuery}`)= i

                if endPage < pagination.totalPages
                  if endPage < pagination.totalPages - 1
                    span.px-3.py-2.text-gray-400 ...
                  a.outline.px-3.py-2(href=`/admin/species?page=${pagination.totalPages}${baseQuery}`)= pagination.totalPages

              if pagination.currentPage < pagination.totalPages
                a.outline.px-3.py-2(href=`/admin/species?page=${pagination.currentPage + 1}${baseQuery}`) Next

        else
          .bg-white.rounded-lg.shadow-md.p-12.text-center
            +emptyState("No Species Found", { showIcon: true, iconPath: "M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z", subtitle: "No species match your current filters.", size: "lg" })
            if filters.species_type || filters.program_class || filters.has_base_points !== undefined || filters.is_cares_species !== undefined || filters.search
              .flex.gap-3.mt-4.justify-center
                a.primary.px-4.py-2(href="/admin/species") Clear All Filters
                button.outline.px-4.py-2(type="button" onclick="history.back()") Go Back
