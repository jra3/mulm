include ../header.pug
include ../mixins/iucnBadge.pug
include ../mixins/date.pug

doctype html
html
  +headTag(title)

  body.bg-white.text-gray-800
    +pageHeader(true, title)

    section.bg-gray-100.py-6
      div.max-w-4xl.mx-auto.px-4

        //- Breadcrumb
        .mb-6
          nav.flex(aria-label="Breadcrumb")
            ol.inline-flex.items-center.space-x-1(class="md:space-x-3")
              li.inline-flex.items-center
                a(class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600" href="/admin/species")
                  | Species Management
              li
                .flex.items-center
                  svg.w-6.h-6.text-gray-400(fill="currentColor" viewBox="0 0 20 20")
                    path(fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd")
                  span.ml-1.text-sm.font-medium.text-gray-500(class="md:ml-2")= `${species.canonical_genus} ${species.canonical_species_name}`

        h1.text-2xl.font-bold.text-gray-900.mb-6 Edit Species

        form(
          hx-patch=`/admin/species/${species.group_id}`
          hx-swap="none"
          hx-on--after-request="if(event.detail.successful && event.detail.elt === this) { window.location.href='/admin/species'; }"
        )

          //- Canonical Name Section (Warning)
          .bg-yellow-50.border.border-yellow-200.rounded-lg.p-6.mb-6
            .flex.items-start.gap-3.mb-4
              svg.w-6.h-6.text-yellow-600.flex-shrink-0(fill="currentColor" viewBox="0 0 20 20")
                path(fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd")
              div
                h3.text-base.font-semibold.text-yellow-800 Canonical Name
                p.text-sm.text-yellow-700.mt-1 Changes to the canonical name affect all references throughout the system. Use with caution.

            .grid.gap-4(class="md:grid-cols-2")
              div
                label.input-label(for="canonical_genus") Genus
                input.text-input(
                  type="text"
                  id="canonical_genus"
                  name="canonical_genus"
                  value=species.canonical_genus
                  required
                )

              div
                label.input-label(for="canonical_species_name") Species
                input.text-input(
                  type="text"
                  id="canonical_species_name"
                  name="canonical_species_name"
                  value=species.canonical_species_name
                  required
                )

          //- Classification
          .bg-white.rounded-lg.shadow-md.p-6.mb-6
            h3.text-lg.font-bold.text-gray-900.mb-4 Classification

            .grid.gap-4(class="md:grid-cols-2")
              div
                label.input-label(for="species_type") Species Type
                .text-sm.px-3.py-2.bg-gray-100.rounded.text-gray-700= species.species_type
                p.text-xs.text-gray-500.mt-1 Cannot be changed (affects form fields)

              div
                label.input-label(for="program_class") Program Class
                .select-wrapper
                  select#program_class(name="program_class" required)
                    each cls in classOptions
                      option(value=cls selected=(species.program_class === cls))= cls
                p.text-xs.text-gray-500.mt-1 BAP/HAP/CAP program class

          //- Points & Status
          .bg-white.rounded-lg.shadow-md.p-6.mb-6
            h3.text-lg.font-bold.text-gray-900.mb-4 Points & Conservation Status

            .grid.gap-4(class="md:grid-cols-2")
              div
                label.input-label(for="base_points") Base Points
                .select-wrapper
                  select#base_points(name="base_points")
                    option(value="" selected=!species.base_points) Not assigned
                    option(value="5" selected=species.base_points === 5) 5 points
                    option(value="10" selected=species.base_points === 10) 10 points
                    option(value="15" selected=species.base_points === 15) 15 points
                    option(value="20" selected=species.base_points === 20) 20 points
                p.text-xs.text-gray-500.mt-1 Points awarded for breeding

              div
                label.input-label.mb-3 Conservation Status
                label.flex.items-center.gap-2.cursor-pointer
                  input(
                    type="checkbox"
                    name="is_cares_species"
                    id="is_cares_species"
                    checked=species.is_cares_species
                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  )
                  span.text-sm.font-medium.text-gray-700 CARES Conservation Species
                p.text-xs.text-gray-500.mt-1 Conservation, Awareness, Recognition, Encouragement, Support

          //- IUCN Red List Status
          .bg-white.rounded-lg.shadow-md.p-6.mb-6
            .flex.justify-between.items-center.mb-4
              h3.text-lg.font-bold.text-gray-900 IUCN Red List Status
              - const syncVals = `js:{groupIds: [${species.group_id}]}`
              button.outline.text-xs(
                type="button"
                hx-post="/admin/species/bulk-sync-iucn"
                hx-vals=syncVals
                hx-target="#iucn-refresh-results"
                hx-swap="innerHTML"
                hx-indicator="#iucn-sync-spinner"
              ) Refresh IUCN Data

            //- Results area
            #iucn-refresh-results

            #iucn-status-section
              if species.iucn_redlist_category
                .grid.gap-4(class="md:grid-cols-3")
                  div
                    label.input-label Conservation Status
                    .mt-2
                      +iucnBadge(species.iucn_redlist_category, 'md', true, true, species.iucn_redlist_url)

                  div
                    label.input-label Population Trend
                    .mt-2.flex.items-center.gap-2
                      +populationTrend(species.iucn_population_trend, 'md')
                      span.text-sm.text-gray-700= species.iucn_population_trend || 'Unknown'

                  div
                    label.input-label Last Updated
                    .mt-2.text-sm.text-gray-700
                      if species.iucn_last_updated
                        +shortDate(species.iucn_last_updated)
                      else
                        span.text-gray-400 Never

                .mt-4
                  p.text-xs.text-gray-500
                    | IUCN Red List data is sourced from
                    | #[a(class="text-blue-600 hover:text-blue-800" href="https://www.iucnredlist.org" target="_blank" rel="noopener") www.iucnredlist.org]
              else
                .text-center.py-6
                  svg.w-12.h-12.text-gray-300.mx-auto.mb-2(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                    path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z")
                  p.text-sm.text-gray-600 No IUCN data available for this species
                  p.text-xs.text-gray-500.mt-1 Many aquarium species have not been assessed by IUCN

            //- Loading indicator
            #iucn-sync-spinner.htmx-indicator.mt-2
              .flex.gap-2.items-center.text-blue-600
                svg.animate-spin.h-4.w-4(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24")
                  circle.opacity-25(cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4")
                  path.opacity-75(fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")
                span.text-sm Syncing with IUCN API...

          //- External Links
          .bg-white.rounded-lg.shadow-md.p-6.mb-6
            h3.text-lg.font-bold.text-gray-900.mb-4 External Resources

            .grid.gap-4(class="md:grid-cols-2")
              div
                label.input-label(for="external_references") Reference URLs
                textarea.text-input(
                  id="external_references"
                  name="external_references"
                  rows="4"
                  placeholder="One URL per line (e.g., https://fishbase.org/...)"
                )= species.external_references ? JSON.parse(species.external_references).join('\n') : ''
                p.text-xs.text-gray-500.mt-1 External reference links (one per line)

              div
                label.input-label(for="image_links") Image URLs
                textarea.text-input(
                  id="image_links"
                  name="image_links"
                  rows="4"
                  placeholder="One URL per line (e.g., https://example.com/image.jpg)"
                )= species.image_links ? JSON.parse(species.image_links).join('\n') : ''
                p.text-xs.text-gray-500.mt-1 Image links (one per line)

          //- Name Variants - Split Lists
          .bg-white.rounded-lg.shadow-md.p-6.mb-6
            .grid.grid-cols-1.gap-4(class="md:grid-cols-2")

              //- Common Names
              div
                .flex.justify-between.items-center.mb-3
                  h3.text-base.font-bold.text-gray-900 Common Names (#{commonNames.length})
                  button.outline.text-sm(
                    type="button"
                    hx-get=`/admin/species/${species.group_id}/common-names/new`
                    hx-target="#common-name-list"
                    hx-swap="beforeend"
                  ) + Add

                #common-name-list.space-y-2
                  if commonNames && commonNames.length > 0
                    each name in commonNames
                      .flex.items-center.gap-2.p-2.bg-gray-50.rounded.border.border-gray-200
                        .flex-1.font-medium.text-sm= name.common_name
                        button.destructive.text-xs.px-2.py-1(
                          type="button"
                          hx-delete=`/admin/species/${species.group_id}/common-names/${name.common_name_id}`
                          hx-confirm="Delete this common name?"
                          hx-target="closest .flex.items-center"
                          hx-swap="outerHTML swap:0.5s"
                        ) ×
                  else
                    .flex.flex-col.items-center.gap-2.py-6.text-center
                      svg.w-8.h-8.text-gray-300(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z")
                      .text-xs.text-gray-500 No common names yet
                      button.outline.text-xs.mt-1(
                        type="button"
                        hx-get=`/admin/species/${species.group_id}/common-names/new`
                        hx-target="#common-name-list"
                        hx-swap="beforeend"
                      ) Add First Common Name

              //- Scientific Names
              div
                .flex.justify-between.items-center.mb-3
                  h3.text-base.font-bold.text-gray-900 Scientific Names (#{scientificNames.length})
                  button.outline.text-sm(
                    type="button"
                    hx-get=`/admin/species/${species.group_id}/scientific-names/new`
                    hx-target="#scientific-name-list"
                    hx-swap="beforeend"
                  ) + Add

                #scientific-name-list.space-y-2
                  if scientificNames && scientificNames.length > 0
                    each name in scientificNames
                      .flex.items-center.gap-2.p-2.bg-gray-50.rounded.border.border-gray-200
                        .flex-1.font-medium.text-sm.italic= name.scientific_name
                        button.destructive.text-xs.px-2.py-1(
                          type="button"
                          hx-delete=`/admin/species/${species.group_id}/scientific-names/${name.scientific_name_id}`
                          hx-confirm="Delete this scientific name?"
                          hx-target="closest .flex.items-center"
                          hx-swap="outerHTML swap:0.5s"
                        ) ×
                  else
                    .flex.flex-col.items-center.gap-2.py-6.text-center
                      svg.w-8.h-8.text-gray-300(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                        path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
                      .text-xs.text-gray-500 No scientific names yet
                      button.outline.text-xs.mt-1(
                        type="button"
                        hx-get=`/admin/species/${species.group_id}/scientific-names/new`
                        hx-target="#scientific-name-list"
                        hx-swap="beforeend"
                      ) Add First Scientific Name

          //- Actions
          .flex.gap-3.justify-center
            button.primary(type="submit" hx-disabled-elt="this") Save Changes
            button.outline(type="button" onclick="window.location.href='/admin/species'") Cancel

          //- Danger Zone
          .mt-6.pt-6.border-t.border-gray-300
            .bg-red-50.border.border-red-200.rounded-lg.p-4
              h4.text-sm.font-semibold.text-red-800.mb-2 Danger Zone
              p.text-sm.text-red-700.mb-3 Merge this species into another or delete it permanently.

              .flex.flex-col.gap-2
                button.outline.w-full(
                  type="button"
                  hx-get=`/admin/dialog/species/${species.group_id}/merge`
                  hx-target="body"
                  hx-swap="beforeend"
                ) Merge Into Another Species

                button.destructive.w-full(
                  type="button"
                  hx-delete=`/admin/species/${species.group_id}`
                  hx-confirm="Delete this species and all its synonyms? This cannot be undone."
                  hx-on--after-request="if(event.detail.successful) { window.location.href='/admin/species'; }"
                ) Delete Species

    +footer()

    // HTMX event handlers
    script.
      // Reload page after IUCN sync completes (for single species)
      document.body.addEventListener('pageReload', function() {
        setTimeout(function() {
          window.location.reload();
        }, 1000);
      });

      // Temporary HTMX debugging
      document.body.addEventListener('htmx:beforeRequest', function(evt) {
        console.log('HTMX beforeRequest:', evt.detail);
      });
      document.body.addEventListener('htmx:afterRequest', function(evt) {
        console.log('HTMX afterRequest:', evt.detail);
      });
      document.body.addEventListener('htmx:responseError', function(evt) {
        console.log('HTMX responseError:', evt.detail);
      });
