include ../header.pug
include ../mixins/date.pug
include ../mixins/caresBadge.pug
include ../mixins/iucnBadge.pug
include ../mixins/emptyState.pug
include ../mixins/card.pug

- const stringCell = ['p-3', 'overflow-hidden', 'text-ellipsis', 'whitespace-nowrap', 'border-gray-300'];
- const heading = ['p-3', 'text-left', 'font-semibold', 'text-gray-700', 'bg-gray-50', 'border-gray-300'];

doctype html
html
	+headTag(title)

	body.bg-white.text-gray-800
		+pageHeader(isLoggedIn, displayName)

		section.bg-gray-100.py-6
			div.max-w-6xl.mx-auto.px-4
				
				// Breadcrumb
				.mb-6
					nav.flex(aria-label="Breadcrumb")
						ol.inline-flex.items-center.space-x-1(class="md:space-x-3")
							li.inline-flex.items-center
								a(class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600" href="/species")
									| Species Explorer
							li
								.flex.items-center
									svg.w-6.h-6.text-gray-400(fill="currentColor" viewBox="0 0 20 20")
										path(fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd")
									span.ml-1.text-sm.font-medium.text-gray-500(class="md:ml-2")= displayName

				// Species Header
				.bg-white.rounded-lg.shadow-md.p-6.mb-6
					.flex.flex-col.items-start.justify-between(class="lg:flex-row lg:items-center")
						div
							.flex.items-center.gap-2.mb-2
								h1.text-3xl.font-bold.text-gray-900= displayName
								if species.is_cares_species == 1
									+caresBadgeWithHover('md', species, species.group_id)
								if species.iucn_redlist_category
									+iucnBadgeWithHover(species, species.group_id, 'md')
							p.text-lg.text-gray-600
								span.inline-block.px-3.py-1.text-sm.font-medium.bg-blue-100.text-blue-800.rounded-full
									= species.program_class
								if species.iucn_population_trend
									span.ml-2
										+populationTrend(species.iucn_population_trend, 'md')
						div.mt-4(class="lg:mt-0")
							.flex.flex-col.space-y-2.text-sm.text-gray-600
								div
									strong Total Reports: 
									span.text-green-600.font-semibold= totalBreeds
								div
									strong Expert Breeders:
									span.text-purple-600.font-semibold= totalBreeders

				// Current Keepers
				if keeperCount > 0
					.bg-blue-50.border.border-blue-200.rounded-lg.p-4.mb-6
						.flex.items-center.justify-between.mb-3
							.flex.items-center.gap-2
								i.fas.fa-users.text-blue-600.text-xl
								span.font-medium.text-blue-900
									= `${keeperCount} member${keeperCount === 1 ? '' : 's'} currently keep${keeperCount === 1 ? 's' : ''} this species`
							if viewer && viewer.id
								button.px-3.py-1.text-sm.font-medium.text-white.bg-blue-600.hover_bg-blue-700.rounded-md(
									hx-get="/dialog/collection/add"
									hx-target="body"
									hx-swap="beforeend"
									title="Add to my collection"
								)
									i.fas.fa-plus.mr-1
									| Add to Collection

						if keepers && keepers.length > 0
							.border-t.border-blue-200.pt-3
								.text-sm.text-blue-700.mb-2 Keepers:
								.flex.flex-wrap.gap-2
									each keeper in keepers.slice(0, 10)
										a.inline-flex.items-center.px-2.py-1.text-sm.text-blue-700.bg-white.hover_bg-blue-100.rounded.border.border-blue-300.transition(
											href=`/member/${keeper.id}`
											title=`View ${keeper.display_name}'s profile`
										)
											i.fas.fa-user.mr-1
											= keeper.display_name
									if keepers.length > 10
										span.text-sm.text-blue-600= `+${keepers.length - 10} more`

				// External References & Images
				if (species.external_references && species.external_references.length > 0) || (species.image_links && species.image_links.length > 0)
					.bg-white.rounded-lg.shadow-md.p-6.mb-6
						h2.text-xl.font-bold.text-gray-900.mb-4 External Resources

						// External Links
						if species.external_references && species.external_references.length > 0
							.mb-6
								h3.text-base.font-semibold.text-gray-700.mb-3 Reference Links
								.space-y-2
									each url in species.external_references
										a.flex.items-center.p-3.bg-gray-50.hover_bg-gray-100.rounded.border.border-gray-200.transition.group(
											href=url
											target="_blank"
											rel="noopener noreferrer"
										)
											i.fas.fa-external-link-alt.text-blue-600.mr-3
											.flex-1
												.font-medium.text-blue-700.group-hover_text-blue-900
													if url.includes('fishbase.se')
														| FishBase Species Page
													else if url.includes('wikipedia.org')
														| Wikipedia Article
													else if url.includes('gbif.org')
														| GBIF Species Page
													else
														| External Reference
												.text-sm.text-gray-500.truncate= url
											i.fas.fa-arrow-right.text-gray-400.group-hover_text-blue-600.ml-2

						// Species Images
						if species.images && species.images.length > 0
							div
								h3.text-base.font-semibold.text-gray-700.mb-3 Species Images
								.grid.grid-cols-2.gap-4(class="md:grid-cols-3 lg:grid-cols-4")
									each image in species.images
										.group
											a.block.relative.aspect-square.bg-gray-100.rounded-lg.overflow-hidden.border.border-gray-200.hover_border-blue-500.transition(
												href=image.image_url
												target="_blank"
												rel="noopener noreferrer"
												title=image.title || "View full size image"
											)
												img.w-full.h-full.object-cover.transition(
													src=image.image_url
													alt=image.title || `${displayName} - Species Photo`
													loading="lazy"
													onerror="this.parentElement.innerHTML='<div class=\"flex items-center justify-center h-full text-gray-400\"><i class=\"fas fa-image-slash text-3xl\"></i></div>'"
												)
											if image.attribution || image.license
												.mt-1.text-xs.text-gray-500.truncate
													if image.attribution
														span= image.attribution
													if image.license
														span.ml-1.text-gray-400= `(${image.license})`

				// Name Variations - Split by Type
				if (commonNames && commonNames.length > 0) || (scientificNames && scientificNames.length > 0)
					.bg-white.rounded-lg.shadow-md.p-6.mb-6
						h2.text-xl.font-bold.text-gray-900.mb-4 Known Names
						.grid.grid-cols-1.gap-6(class="md:grid-cols-2")

							// Common Names
							div
								h3.text-base.font-semibold.text-gray-700.mb-3 Common Names
								if commonNames && commonNames.length > 0
									.space-y-2
										each name in commonNames
											.p-3.bg-gray-50.rounded.border.border-gray-200
												.font-medium.text-gray-900= name.common_name
								else
									.text-center.py-4
										.text-sm.text-gray-500 No common names recorded

							// Scientific Names
							div
								h3.text-base.font-semibold.text-gray-700.mb-3 Scientific Names
								if scientificNames && scientificNames.length > 0
									.space-y-2
										each name in scientificNames
											.p-3.bg-gray-50.rounded.border.border-gray-200
												.font-medium.text-gray-900.italic= name.scientific_name
								else
									.text-center.py-4
										.text-sm.text-gray-500 No scientific names recorded

				// Expert Breeders
				if breeders.length > 0
					.bg-white.rounded-lg.shadow-md.p-6
						h2.text-xl.font-bold.text-gray-900.mb-4 Expert Breeders
						
						.grid.grid-cols-1.gap-6(class="lg:grid-cols-2")
							each breeder in breeders
								+card({variant: 'content', margin: ''})
									.flex.justify-between.items-start.mb-3
										div
											a(class="text-lg font-semibold text-blue-600 hover:text-blue-800" href=`/member/${breeder.member_id}`)= breeder.member_name
											.text-sm.text-gray-600
												= breeder.breed_count
												= breeder.breed_count === 1 ? ' breeding report' : ' breeding reports'
										div.text-right.text-sm.text-gray-600
											div
												strong First:
												+shortDate(breeder.first_breed_date, "First breed date")
											if breeder.first_breed_date !== breeder.latest_breed_date
												div
													strong Latest:
													+shortDate(breeder.latest_breed_date, "Latest breed date")

									// Breeding Reports
									if breeder.submissions && breeder.submissions.length > 0
										.space-y-2
											h4.font-medium.text-gray-900 Breeding Reports:
											each submission in breeder.submissions
												.flex.justify-between.items-center.text-sm.bg-gray-50.rounded.p-2
													div
														a(class="text-blue-600 hover:text-blue-800" href=`/submissions/${submission.id}`)
															if submission.species_common_name
																= submission.species_common_name
															else
																= submission.species_latin_name
													div.text-right
														.text-green-600.font-medium= submission.points + ' pts'
														.text-gray-500
															+shortDate(submission.approved_on, "Approved on")

				else
					+emptyState("No breeding reports found for this species.", { showCard: true, size: "lg", subtitle: "This species may be in our database but hasn't been successfully bred yet." })

		+footer()