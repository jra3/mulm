include ./card.pug
include ./hoverCard.pug
include ./caresBadge.pug

//- Collection Card Mixin
//-
//- Displays a single species in a member's collection
//- Handles both canonical species (from database) and free-text entries
//-
//- @param {Object} entry - Collection entry
//- @param {Boolean} canEdit - Whether the viewer can edit this entry
//- @param {Object} options - Display options
//- @param {String} options.variant - 'compact'|'default'|'large' (default: 'default')

mixin collectionCard(entry, canEdit = false, options = {})
	- const variant = options.variant || 'default'
	- const species = entry.species || {}
	- const hovercardId = `collection-${entry.id}-species`
	- const isCanonical = Boolean(entry.group_id)
	- const padding = variant === 'large' ? 'lg' : (variant === 'compact' ? 'sm' : 'md')
	- const hasImages = entry.images && entry.images.length > 0

	+card({variant: 'default', padding, shadow: true, extraClasses: 'hover:shadow-lg transition-shadow'})
		.flex.flex-col.h-full

			//- Header: Species info
			.flex.justify-between.items-start.mb-4
				.flex-1.min-w-0
					if isCanonical
						//- Canonical species - with hover card and link
						+hoverCard({id: hovercardId, side: 'top', width: 'lg', openDelay: 300})
							+hoverCardTrigger()
								a.link.font-medium(href=`/species/${entry.group_id}`)
									if entry.common_name
										div(class=variant === 'large' ? 'text-xl' : 'text-base' class="text-gray-900 truncate")= entry.common_name
									if entry.scientific_name
										div(class=variant === 'large' ? 'text-base' : 'text-sm' class="italic text-gray-600")= entry.scientific_name
									else
										div(class=variant === 'large' ? 'text-xl' : 'text-base' class="text-gray-900") Unknown Species
							+hoverCardContent({cardClasses: 'hovercard-green-border'})
								if entry.common_name
									h3.font-semibold.text-lg= entry.common_name
								if entry.scientific_name
									p.italic.text-sm.text-gray-600= entry.scientific_name
								if species.program_class
									p.mt-2
										span.inline-block.px-2.py-1.text-xs.font-medium.bg-blue-100.text-blue-800.rounded-full
											= species.program_class
								if species.is_cares_species
									.mt-2
										+caresBadge()
					else
						//- Non-canonical species - no link or hover card
						.font-medium
							if entry.common_name
								div(class=variant === 'large' ? 'text-xl' : 'text-base' class="text-gray-900 truncate")= entry.common_name
							if entry.scientific_name
								div(class=variant === 'large' ? 'text-base' : 'text-sm' class="italic text-gray-600")= entry.scientific_name
							if canEdit
								a.link(
									class=variant === 'large' ? 'text-sm' : 'text-xs'
									class="mt-1 inline-block"
									href="#"
									hx-get=`/dialog/collection/link/${entry.id}`
									hx-target="body"
									hx-swap="beforeend"
								) Link to database species
							else
								div(class=variant === 'large' ? 'text-sm' : 'text-xs' class="text-gray-500 mt-1") (Custom entry)

				if canEdit
					button.ml-2.inline-flex.items-center.justify-center.px-3.py-2.text-sm.font-medium.text-blue-600.bg-blue-50.hover_bg-blue-100.rounded-md.border.border-blue-200.transition(
						hx-get=`/dialog/collection/edit/${entry.id}`
						hx-target="body"
						hx-swap="beforeend"
						title="Edit entry"
					) Edit

			//- Images - larger display for 'large' variant
			if hasImages
				div(class=variant === 'large' ? 'mb-4' : 'mb-3')
					if variant === 'large'
						//- Large variant: Show all images in a nice grid
						div(class=entry.images.length === 1 ? 'grid grid-cols-1' : entry.images.length === 2 ? 'grid grid-cols-2 gap-2' : 'grid grid-cols-2 gap-2' class="sm:grid-cols-3")
							each img, idx in entry.images
								.relative.aspect-video.overflow-hidden.rounded-lg
									img.w-full.h-full.object-cover(
										src=img.url.replace('-original', '-medium')
										alt=`${entry.common_name || 'Species'} photo ${idx + 1}`
										loading="lazy"
										class="cursor-pointer"
										onclick=`window.open('${img.url}', '_blank')`
									)
					else
						//- Compact/default: Show up to 3 thumbnails
						.grid.gap-1(class=entry.images.length === 1 ? 'grid-cols-1' : 'grid-cols-3')
							- const displayImages = entry.images.slice(0, 3)
							each img, idx in displayImages
								.relative.aspect-video.overflow-hidden.rounded
									img.w-full.h-full.object-cover(
										src=img.url.replace('-original', '-thumb')
										alt=`${entry.common_name || 'Species'} photo ${idx + 1}`
										loading="lazy"
									)
							if entry.images.length > 3
								.flex.items-center.justify-center.bg-gray-100.rounded.aspect-video
									span.text-sm.font-medium.text-gray-600= `+${entry.images.length - 3}`

			//- CARES Gold Seal (if registered)
			if entry.cares_registered_at
				.flex.items-center.gap-2.mb-3.bg-yellow-50.border.border-yellow-200.rounded-lg.px-3.py-2
					.text-xl.flex-shrink-0 ðŸŸ¡
					.flex-1
						.text-sm.font-semibold.text-yellow-800 CARES Registered
						.text-xs.text-yellow-600= `Since ${new Date(entry.cares_registered_at).toLocaleDateString()}`
					if canEdit
						button.text-xs.text-yellow-700.hover_text-yellow-900.underline(
							hx-get=`/dialog/cares/register/${entry.id}`
							hx-target="body"
							hx-swap="beforeend"
						) Edit Photo

			//- CARES photo (if registered and has photo)
			if entry.cares_registered_at && entry.cares_photo_url
				.mb-3
					.relative.aspect-video.overflow-hidden.rounded-lg.border.border-yellow-200
						img.w-full.h-full.object-cover(
							src=entry.cares_photo_url.replace('-original', '-medium')
							alt=`${entry.common_name || 'Species'} CARES photo`
							loading="lazy"
							class="cursor-pointer"
							onclick=`window.open('${entry.cares_photo_url}', '_blank')`
						)

			//- Details: dates, visibility
			div(class=variant === 'large' ? 'text-base' : 'text-sm' class="text-gray-600 mb-3 space-y-2")
				if entry.acquired_date
					.flex.items-center.gap-2
						i.fas.fa-calendar-plus.w-4
						span
							strong Acquired:
							= ` ${new Date(entry.acquired_date).toLocaleDateString()}`
				if entry.removed_date
					.flex.items-center.gap-2.text-red-600
						i.fas.fa-calendar-minus.w-4
						span
							strong Removed:
							= ` ${new Date(entry.removed_date).toLocaleDateString()}`
				if entry.visibility === 'private'
					.flex.items-center.gap-2.text-purple-600
						i.fas.fa-lock.w-4
						span
							strong Private
				if isCanonical && species.program_class
					.flex.items-center.gap-2
						i.fas.fa-tag.w-4
						span
							= species.program_class
							if species.is_cares_species
								|
								+caresBadge('sm')

			//- CARES registration CTA (for eligible, unregistered species)
			if canEdit && isCanonical && species.is_cares_species && !entry.cares_registered_at
				.mb-3
					button.w-full.inline-flex.items-center.justify-center.gap-2.px-3.py-2.text-sm.font-medium.text-green-700.bg-green-50.hover_bg-green-100.rounded-md.border.border-green-200.transition(
						hx-get=`/dialog/cares/register/${entry.id}`
						hx-target="body"
						hx-swap="beforeend"
					)
						span ðŸŸ
						span Register for CARES

			//- Notes (if any)
			if entry.notes
				div(class=variant === 'large' ? 'text-base' : 'text-sm' class="text-gray-700 mt-auto pt-3 border-t border-gray-200")
					p(class=variant === 'large' ? '' : 'line-clamp-3')= entry.notes


//- Collection Summary Card - Shows stats
mixin collectionSummary(stats)
	+card({variant: 'info', padding: 'md'})
		.flex.items-center.justify-between
			div
				.text-2xl.font-bold.text-blue-900= stats.current || 0
				.text-sm.text-blue-700 Current Species
			.text-gray-400
				i.fas.fa-fish(class="text-4xl")
		if stats.lifetime && stats.lifetime > stats.current
			.mt-3.pt-3.border-t.border-blue-200
				.text-sm.text-blue-700
					= `${stats.lifetime} total species kept (lifetime)`
