include ./card.pug
include ./hoverCard.pug
include ./caresBadge.pug

//- Collection Card Mixin
//-
//- Displays a single species in a member's collection
//- Handles both canonical species (from database) and free-text entries
//-
//- @param {Object} entry - Collection entry
//- @param {Boolean} canEdit - Whether the viewer can edit this entry
//- @param {Boolean} options.compact - Use compact layout (default: false)

mixin collectionCard(entry, canEdit = false, options = {})
	- const compact = options.compact || false
	- const species = entry.species || {}
	- const hovercardId = `collection-${entry.id}-species`
	- const isCanonical = Boolean(entry.group_id)

	+card({variant: 'default', padding: compact ? 'sm' : 'md', shadow: true, extraClasses: 'hover:shadow-md transition-shadow'})
		.flex.flex-col.h-full

			//- Header: Species info
			.flex.justify-between.items-start.mb-3
				.flex-1.min-w-0
					if isCanonical
						//- Canonical species - with hover card and link
						+hoverCard({id: hovercardId, side: 'top', width: 'lg', openDelay: 300})
							+hoverCardTrigger()
								a.link.font-medium(href=`/species/${entry.group_id}`)
									if entry.common_name
										.text-base.text-gray-900.truncate= entry.common_name
									if entry.scientific_name
										.text-sm.italic.text-gray-600= entry.scientific_name
									else
										.text-base.text-gray-900 Unknown Species
							+hoverCardContent({cardClasses: 'hovercard-green-border'})
								if entry.common_name
									h3.font-semibold.text-lg= entry.common_name
								if entry.scientific_name
									p.italic.text-sm.text-gray-600= entry.scientific_name
								if species.program_class
									p.mt-2
										span.inline-block.px-2.py-1.text-xs.font-medium.bg-blue-100.text-blue-800.rounded-full
											= species.program_class
								if species.is_cares_species
									.mt-2
										+caresBadge()
					else
						//- Non-canonical species - no link or hover card
						.font-medium
							if entry.common_name
								.text-base.text-gray-900.truncate= entry.common_name
							if entry.scientific_name
								.text-sm.italic.text-gray-600= entry.scientific_name
							.text-xs.text-gray-500.mt-1 (Custom entry)

				if canEdit
					button.ml-2.text-gray-400.hover_text-gray-600.transition(
						hx-get=`/dialog/collection/edit/${entry.id}`
						hx-target="body"
						hx-swap="beforeend"
						title="Edit entry"
					)
						i.fas.fa-edit

			//- Details: dates, visibility
			.text-sm.text-gray-600.mb-3.space-y-1
				if entry.acquired_date
					.flex.items-center.gap-2
						i.fas.fa-calendar-plus.w-4
						span
							strong Acquired:
							= ` ${new Date(entry.acquired_date).toLocaleDateString()}`
				if entry.removed_date
					.flex.items-center.gap-2.text-red-600
						i.fas.fa-calendar-minus.w-4
						span
							strong Removed:
							= ` ${new Date(entry.removed_date).toLocaleDateString()}`
				if entry.visibility === 'private'
					.flex.items-center.gap-2.text-purple-600
						i.fas.fa-lock.w-4
						span
							strong Private

			//- Images (if any)
			if entry.images && entry.images.length > 0
				.mb-3
					.grid.gap-1(class=entry.images.length === 1 ? 'grid-cols-1' : 'grid-cols-3')
						- const displayImages = entry.images.slice(0, 3)
						each img, idx in displayImages
							.relative.aspect-video.overflow-hidden.rounded
								img.w-full.h-full.object-cover(
									src=img.url.replace('-original', '-thumb')
									alt=`${entry.common_name || 'Species'} photo ${idx + 1}`
									loading="lazy"
								)
						if entry.images.length > 3
							.flex.items-center.justify-center.bg-gray-100.rounded.aspect-video
								span.text-sm.font-medium.text-gray-600= `+${entry.images.length - 3}`

			//- Notes (if any)
			if entry.notes
				.text-sm.text-gray-700.mt-auto.pt-2.border-t.border-gray-200
					p.line-clamp-3= entry.notes


//- Collection Summary Card - Shows stats
mixin collectionSummary(stats)
	+card({variant: 'info', padding: 'md'})
		.flex.items-center.justify-between
			div
				.text-2xl.font-bold.text-blue-900= stats.current || 0
				.text-sm.text-blue-700 Current Species
			.text-gray-400
				i.fas.fa-fish(class="text-4xl")
		if stats.lifetime && stats.lifetime > stats.current
			.mt-3.pt-3.border-t.border-blue-200
				.text-sm.text-blue-700
					= `${stats.lifetime} total species kept (lifetime)`
