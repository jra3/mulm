//- IUCN Red List Badge Mixin
//- Displays a color-coded badge for IUCN conservation status
//-
//- Parameters:
//-   category - IUCN category code: CR, EN, VU, NT, LC, DD, NE, EW, EX
//-   size - Size variant: 'sm' (small, inline), 'md' (medium, default)
//-   showLabel - Show full label instead of just code (default: false)
//-   link - If true, links to IUCN Red List
//-   iucnUrl - Direct IUCN URL (preferred) or scientific name for search fallback

include hoverCard.pug
include date.pug

mixin iucnBadge(category, size, showLabel, link, iucnUrl)
  - size = size || 'md'
  - showLabel = showLabel || false
  - link = link || false

  - const sizeClasses = size === 'sm' ? 'px-2 py-0.5 text-xs' : 'px-3 py-1 text-sm'
  - const linkUrl = iucnUrl || null

  if category === 'CR'
    - const config = {bg: 'bg-red-100', text: 'text-red-800', hover: 'hover:bg-red-200', label: 'Critically Endangered'}
    - const displayText = showLabel ? config.label : 'CR'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'EN'
    - const config = {bg: 'bg-orange-100', text: 'text-orange-800', hover: 'hover:bg-orange-200', label: 'Endangered'}
    - const displayText = showLabel ? config.label : 'EN'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'VU'
    - const config = {bg: 'bg-yellow-100', text: 'text-yellow-800', hover: 'hover:bg-yellow-200', label: 'Vulnerable'}
    - const displayText = showLabel ? config.label : 'VU'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'NT'
    - const config = {bg: 'bg-blue-100', text: 'text-blue-800', hover: 'hover:bg-blue-200', label: 'Near Threatened'}
    - const displayText = showLabel ? config.label : 'NT'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'LC'
    - const config = {bg: 'bg-green-100', text: 'text-green-800', hover: 'hover:bg-green-200', label: 'Least Concern'}
    - const displayText = showLabel ? config.label : 'LC'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'DD'
    - const config = {bg: 'bg-gray-100', text: 'text-gray-800', hover: 'hover:bg-gray-200', label: 'Data Deficient'}
    - const displayText = showLabel ? config.label : 'DD'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'NE'
    - const config = {bg: 'bg-gray-100', text: 'text-gray-600', hover: 'hover:bg-gray-200', label: 'Not Evaluated'}
    - const displayText = showLabel ? config.label : 'NE'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'EW'
    - const config = {bg: 'bg-red-100', text: 'text-red-900', hover: 'hover:bg-red-200', label: 'Extinct in Wild'}
    - const displayText = showLabel ? config.label : 'EW'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else if category === 'EX'
    - const config = {bg: 'bg-black', text: 'text-white', hover: 'hover:bg-gray-800', label: 'Extinct'}
    - const displayText = showLabel ? config.label : 'EX'
    - const baseClasses = `inline-flex items-center rounded-full font-semibold ${config.bg} ${config.text} ${sizeClasses}`
    if link && linkUrl
      a(class=`${baseClasses} ${config.hover}` href=linkUrl target="_blank" rel="noopener noreferrer" title=config.label)= displayText
    else
      span(class=baseClasses title=config.label)= displayText

  else
    //- No IUCN data available
    span(class=`inline-flex items-center rounded-full font-medium bg-gray-50 text-gray-400 ${sizeClasses}` title="IUCN status not available") —

//- Population Trend Indicator Mixin
//- Shows arrow indicators for population trends
//-
//- Parameters:
//-   trend - Population trend: 'Increasing', 'Decreasing', 'Stable', 'Unknown'
//-   size - Size: 'sm', 'md' (default)

mixin populationTrend(trend, size)
  - const sizeClass = size === 'sm' ? 'text-sm' : 'text-base'

  if trend === 'Increasing'
    span(class=`${sizeClass} text-green-600` title="Population Increasing") ↑
  else if trend === 'Decreasing'
    span(class=`${sizeClass} text-red-600` title="Population Decreasing") ↓
  else if trend === 'Stable'
    span(class=`${sizeClass} text-blue-600` title="Population Stable") ↔
  else if trend === 'Unknown'
    span(class=`${sizeClass} text-gray-400` title="Population Trend Unknown") ?
  else
    span(class=`${sizeClass} text-gray-300`) —

//- IUCN Badge with HoverCard Enhancement
//- Wraps the standard IUCN badge with a rich HoverCard tooltip
//-
//- Parameters:
//-   species - Species object with IUCN data
//-     Required: iucn_redlist_category
//-     Optional: iucn_population_trend, iucn_last_updated, iucn_redlist_url
//-   uniqueId - Unique identifier for this instance (e.g., species ID or group ID)
//-   size - Badge size: 'sm', 'md' (default: 'md')
//-
//- Usage:
//-   +iucnBadgeWithHover(species, species.group_id)

mixin iucnBadgeWithHover(species, uniqueId, size)
  - if (!species.iucn_redlist_category) return
  - size = size || 'md'
  - const category = species.iucn_redlist_category
  - const trend = species.iucn_population_trend
  - const lastUpdated = species.iucn_last_updated
  - const iucnUrl = species.iucn_redlist_url
  -
  - // Get category info
  - let categoryName = 'Unknown'
  - let categoryDesc = 'Status unknown.'
  - if (category === 'CR') { categoryName = 'Critically Endangered'; categoryDesc = 'Faces an extremely high risk of extinction in the wild.'; }
  - else if (category === 'EN') { categoryName = 'Endangered'; categoryDesc = 'Faces a very high risk of extinction in the wild.'; }
  - else if (category === 'VU') { categoryName = 'Vulnerable'; categoryDesc = 'Faces a high risk of extinction in the wild.'; }
  - else if (category === 'NT') { categoryName = 'Near Threatened'; categoryDesc = 'Likely to become threatened in the near future.'; }
  - else if (category === 'LC') { categoryName = 'Least Concern'; categoryDesc = 'Widespread and abundant, lowest conservation concern.'; }
  - else if (category === 'DD') { categoryName = 'Data Deficient'; categoryDesc = 'Not enough data available to assess extinction risk.'; }
  - else if (category === 'NE') { categoryName = 'Not Evaluated'; categoryDesc = 'Has not yet been evaluated against the criteria.'; }
  - else if (category === 'EW') { categoryName = 'Extinct in the Wild'; categoryDesc = 'Known only to survive in captivity or as naturalized populations.'; }
  - else if (category === 'EX') { categoryName = 'Extinct'; categoryDesc = 'No known individuals remaining.'; }

  +hoverCard({id: `iucn-${uniqueId}`, side: 'top', width: 'lg', openDelay: 200, closeDelay: 300})
    +hoverCardTrigger()
      +iucnBadge(category, size, false, false)

    +hoverCardContent({cardClasses: 'border-2 border-green-400'})
      .space-y-3
        //- Header: Category name and badge
        .flex.items-center.gap-3
          +iucnBadge(category, 'md', false, false)
          div
            .font-bold.text-gray-900= categoryName
            .text-xs.text-gray-500 IUCN Red List Status

        //- Divider
        .border-t.border-gray-200

        //- Description
        .text-sm.text-gray-700= categoryDesc

        //- Population Trend
        if trend
          .flex.items-center.gap-2
            .text-sm.font-semibold.text-gray-700 Population Trend:
            if trend === 'Increasing'
              .flex.items-center.gap-1.text-green-600
                span ↑
                span.text-sm Increasing
            else if trend === 'Decreasing'
              .flex.items-center.gap-1.text-red-600
                span ↓
                span.text-sm Decreasing
            else if trend === 'Stable'
              .flex.items-center.gap-1.text-blue-600
                span ↔
                span.text-sm Stable
            else if trend === 'Unknown'
              .flex.items-center.gap-1.text-gray-500
                span ?
                span.text-sm Unknown

        //- Last Assessment
        if lastUpdated
          .text-xs.text-gray-600
            span.font-semibold Last assessed:
            +shortDate(lastUpdated, "Last IUCN assessment")

        //- Link to IUCN Red List
        if iucnUrl
          .border-t.border-gray-200.pt-2
            a(
              href=iucnUrl
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-1 text-sm font-medium text-blue-600 hover:text-blue-800"
            )
              span View on IUCN Red List
              svg.w-4.h-4(fill="none" stroke="currentColor" viewBox="0 0 24 24")
                path(stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14")
