include ../header.pug
include ../mixins/errorMessage.pug

+dialog()
	h2.text-2xl.font-bold.mb-2 Add to Collection
	p.text-gray-600.text-sm.mb-4 Track species you currently keep in your tanks.

	form(
		hx-post="/api/collection"
		hx-target="#dialogContent"
		hx-swap="innerHTML"
	)
		.flex.flex-col.gap-3

			//- Option 1: Select from database
			.space-y-2
				label.input-label(for="species-search") Select from Database
				select#species-search.tom-select-typeahead(
					name="group_id"
					data-api-url="/api/species/search"
					data-value-field="group_id"
					data-label-field="text"
					data-search-fields="text,common_name,scientific_name"
					data-min-query-length="2"
					data-max-items="1"
					data-placeholder="Search species..."
				)
				+errorMessage('group_id')

			//- Option 2: Manual entry
			.space-y-2
				.text-center.text-xs.text-gray-500.my-2 Or enter manually:

				.grid.gap-3(class="grid-cols-1 sm:grid-cols-2")
					.space-y-1
						label.input-label(for="common_name") Common Name
						input.text-input(
							type="text"
							id="common_name"
							name="common_name"
							maxlength="200"
							placeholder="e.g., Fancy Guppy"
						)
						+errorMessage('common_name')

					.space-y-1
						label.input-label(for="scientific_name") Scientific (optional)
						input.text-input(
							type="text"
							id="scientific_name"
							name="scientific_name"
							maxlength="200"
							placeholder="e.g., Poecilia reticulata"
						)
						+errorMessage('scientific_name')

			//- Other fields in a compact grid
			.grid.gap-3(class="grid-cols-1 sm:grid-cols-2")
				.space-y-1
					label.input-label(for="acquired_date") Acquired Date (optional)
					input.text-input(
						type="date"
						id="acquired_date"
						name="acquired_date"
					)
					+errorMessage('acquired_date')

				.flex.items-center.gap-2.pt-6
					input(type="checkbox" id="visibility_private" name="visibility" value="private")
					label.text-sm(for="visibility_private") Keep private

			//- Notes
			.space-y-1
				label.input-label(for="notes") Notes (optional)
				textarea.text-input(
					id="notes"
					name="notes"
					rows="2"
					maxlength="500"
					placeholder="Notes about specimens..."
				)
				+errorMessage('notes')

			.flex.gap-2.justify-end.pt-2
				button.outline(
					type="button"
					hx-on:click="document.getElementById('dialog').remove()"
				) Cancel
				button.primary(type="submit") Add to Collection

	//- Initialize typeahead after dialog is in DOM
	script.
		(function() {
			const typeahead = document.getElementById('species-search');
			if (typeahead && typeof TomSelect !== 'undefined' && typeof getTypeaheadConfig === 'function') {
				const config = getTypeaheadConfig(typeahead);
				const options = buildTomSelectOptions(typeahead, config);
				const instance = new TomSelect(typeahead, options);
				if (config.maxItems === 1) {
					instance.control.classList.add('single-value');
				}
			}
		})();
