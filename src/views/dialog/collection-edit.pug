include ../header.pug
include ../mixins/errorMessage.pug

+dialog()
	h2.text-2xl.font-bold.mb-4 Edit Collection Entry

	form(
		hx-patch=`/api/collection/${entry.id}`
		hx-target="#dialogContent"
		hx-swap="innerHTML"
	)
		.flex.flex-col.gap-3

			//- Species names (editable)
			.grid.gap-3(class="grid-cols-1 sm:grid-cols-2")
				.space-y-1
					label.input-label(for="common_name") Common Name
					input.text-input(
						type="text"
						id="common_name"
						name="common_name"
						maxlength="200"
						value=entry.common_name || ''
						placeholder="e.g., Fancy Guppy"
					)
					+errorMessage('common_name')

				.space-y-1
					label.input-label(for="scientific_name") Scientific Name
					input.text-input(
						type="text"
						id="scientific_name"
						name="scientific_name"
						maxlength="200"
						value=entry.scientific_name || ''
						placeholder="e.g., Poecilia reticulata"
					)
					+errorMessage('scientific_name')

			if entry.group_id
				.bg-yellow-50.border-l-4.border-yellow-400.p-2.text-xs.text-yellow-700
					| Note: Editing names will convert this to a custom entry (unlinked from database)

			//- Date and visibility in compact grid
			.grid.gap-3(class="grid-cols-1 sm:grid-cols-2")
				.space-y-1
					.flex.items-center.justify-between
						label.input-label(for="acquired_date") Acquired Date
						a.link.text-xs(
							href="#"
							onclick="event.preventDefault(); document.getElementById('acquired_date').value = '';"
						) clear
					input.text-input(
						type="date"
						id="acquired_date"
						name="acquired_date"
						max=new Date().toISOString().split('T')[0]
						value=entry.acquired_date || ''
					)
					+errorMessage('acquired_date')

				.space-y-1
					label.input-label(for="visibility") Visibility
					select.text-input(
						id="visibility"
						name="visibility"
					)
						option(value="public" selected=entry.visibility === 'public') Public
						option(value="private" selected=entry.visibility === 'private') Private

			//- Notes
			.space-y-1
				label.input-label(for="notes") Notes
				textarea.text-input.h-32(
					id="notes"
					name="notes"
					maxlength="500"
					placeholder="Notes about specimens..."
				)= entry.notes || ''
				+errorMessage('notes')

			//- Image upload section
			.space-y-1
				label.input-label Photos (up to 5)

				//- Upload zone (compact)
				div#image-upload-zone.border-2.border-dashed.border-gray-300.rounded-lg.p-3.text-center.hover_border-gray-400.transition-colors.cursor-pointer(
					onclick="document.getElementById('image-input-edit').click()"
				)
					.text-gray-400.text-2xl ↑
					p.mt-1.text-xs.text-gray-600
						span.font-semibold Click to upload
						|  (PNG, JPG, WebP)

					input#image-input-edit.hidden(
						type="file"
						accept="image/jpeg,image/png,image/webp"
						multiple
						onchange=`uploadCollectionImages(${entry.id}, this.files)`
					)

				//- Image preview grid
				if entry.images && entry.images.length > 0
					div#image-preview-grid.grid.gap-1.mt-2(class="grid-cols-3")
						each img, idx in entry.images
							.relative.group
								img.w-full.h-20.object-cover.rounded(
									src=img.url.replace('-original', '-thumb')
									alt=`Image ${idx + 1}`
								)
								button.absolute.top-0.right-0.bg-red-500.text-white.rounded-full.w-5.h-5.flex.items-center.justify-center.opacity-0.group-hover_opacity-100.transition-opacity.text-xs.font-bold(
									type="button"
									onclick=`removeCollectionImage(${entry.id}, ${idx}, '${img.key}')`
									aria-label="Remove"
								) ×

			.flex.gap-2.justify-end.pt-2.border-t.border-gray-300
				button.outline(
					type="button"
					hx-on:click="document.getElementById('dialog').remove()"
				) Cancel

				if !entry.removed_date
					button.destructive(
						type="button"
						hx-delete=`/api/collection/${entry.id}`
						hx-confirm="Remove this species from your collection?"
						hx-target="#dialogContent"
						hx-swap="innerHTML"
					) Remove

				button.primary(type="submit") Save

	//- JavaScript for image upload
	script.
		async function uploadCollectionImages(entryId, files) {
			if (!files || files.length === 0) return;

			const formData = new FormData();
			for (let i = 0; i < files.length; i++) {
				formData.append('images', files[i]);
			}

			try {
				const response = await fetch(`/api/collection/${entryId}/images`, {
					method: 'POST',
					body: formData
				});

				const result = await response.json();

				if (result.success) {
					window.location.reload();
				} else {
					alert('Upload failed: ' + (result.error || 'Unknown error'));
				}
			} catch (error) {
				console.error('Upload error:', error);
				alert('Upload failed. Please try again.');
			} finally {
				document.getElementById('image-input-edit').value = '';
			}
		}

		async function removeCollectionImage(entryId, index, key) {
			if (!confirm('Remove this image?')) return;
			alert('Image deletion will be implemented in a future update');
		}
