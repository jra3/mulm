include ../mixins/emptyState.pug

#accountLinks
	h2.text-xl.font-bold.mb-4(class="sm:text-2xl") Linked Accounts

	//- Google Account
	.grid.grid-cols-1.w-full.gap-2.mb-4(class="md:grid-cols-2")
		if googleAccount
			.flex.gap-4.items-center#googleAccount
				span.font-bold Google
				span.font-base= googleAccount.google_email
				button.destructive(
					hx-target="#googleAccount"
					hx-delete="/account/google"
				) Unlink
		else
			a(href=googleURL alt='Continue with Google')
				img(src='/google-continue-button.svg')

	//- Facebook Account
	.grid.grid-cols-1.w-full.gap-2.mb-6(class="md:grid-cols-2")
		if facebookAccount
			.flex.gap-4.items-center#facebookAccount
				span.font-bold Facebook
				span.font-base= facebookAccount.facebook_email
				button.destructive(
					hx-target="#facebookAccount"
					hx-delete="/account/facebook"
				) Unlink
		else
			a(href=facebookURL alt='Continue with Facebook')
				img(src='/facebook-signin-button.svg')

	//- Passkeys Section
	h3.text-lg.font-bold.mb-2 Passkeys
	p.text-sm.text-gray-600.mb-4 Manage your passwordless authentication methods (Touch ID, Face ID, Windows Hello, etc.)

	//- Passkey suggestion banner (only shown if no passkeys and not dismissed)
	if !credentials || credentials.length === 0
		#passkeyPrompt.bg-blue-50.border.border-blue-200.rounded-lg.p-4.mb-4.flex.items-start.gap-3(style="display: none;")
			.flex-grow
				p.font-semibold.text-blue-900.mb-1 Try passwordless login!
				p.text-sm.text-blue-700 Add a passkey to log in quickly and securely with Touch ID, Face ID, or Windows Hello. No password needed.
			button.text-blue-600.hover_text-blue-800.font-bold(type="button" onclick="dismissPasskeyPrompt()") âœ•

	button#addPasskeyBtn.primary.mb-4(type="button") Add New Passkey

	#passkeysList.space-y-2
		if credentials && credentials.length > 0
			each cred in credentials
				- const passkeyType = cred.authenticator_attachment === 'platform' ? 'Platform authenticator (Touch ID, Face ID, Windows Hello)' : cred.authenticator_attachment === 'cross-platform' ? 'Security Key' : 'Passkey'
				.flex.gap-4.items-center.p-3.bg-gray-50.rounded(id=`passkey-${cred.id}`)
					.flex-grow
						.font-bold= cred.device_name || 'Unnamed Device'
						.text-sm.text-gray-600= passkeyType
						.text-sm.text-gray-500 Added #{new Date(cred.created_on).toLocaleDateString()}
						if cred.last_used_on
							.text-xs.text-gray-400 Last used #{new Date(cred.last_used_on).toLocaleDateString()}
					button.destructive(
						hx-delete=`/auth/passkey/${cred.id}`
						hx-target=`#passkey-${cred.id}`
						hx-swap="outerHTML"
						hx-confirm="Remove this passkey?"
					) Remove
		else
			+emptyState("No passkeys registered yet")

	script(type="module").
		// Passkey prompt banner - show if not dismissed
		const prompt = document.getElementById('passkeyPrompt');
		if (prompt && !localStorage.getItem('passkeyPromptDismissed')) {
			prompt.style.display = 'flex';
		}

		window.dismissPasskeyPrompt = function() {
			const prompt = document.getElementById('passkeyPrompt');
			if (prompt) {
				prompt.style.display = 'none';
				localStorage.setItem('passkeyPromptDismissed', 'true');
			}
		};

		// Use SimpleWebAuthn browser helpers for proper credential encoding
		import { startRegistration } from 'https://esm.sh/@simplewebauthn/browser@13.2.2';

		const btn = document.getElementById('addPasskeyBtn');
		if (btn) {
			// Check WebAuthn support
			if (!window.PublicKeyCredential) {
				btn.disabled = true;
				btn.textContent = 'Passkeys not supported';
			} else {
				btn.addEventListener('click', async () => {
				try {
					btn.disabled = true;
					btn.textContent = 'Registering...';

					// Prompt for device name first
					const deviceName = window.prompt('Name this passkey (e.g., "iPhone", "MacBook Pro"):');
					if (!deviceName) {
						btn.disabled = false;
						btn.textContent = 'Add New Passkey';
						return;
					}

					// Get registration options from server
					const optRes = await fetch('/auth/passkey/register/options', { method: 'POST' });
					if (!optRes.ok) throw new Error('Server error');
					const opts = await optRes.json();

					// Use SimpleWebAuthn helper - handles all encoding automatically
					const credential = await startRegistration(opts);

					// Verify with server
					const verRes = await fetch('/auth/passkey/register/verify', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ credential, deviceName })
					});

					if (verRes.ok) {
						window.location.reload();
					} else {
						const errorText = await verRes.text();
						throw new Error(errorText || 'Registration failed');
					}
				} catch (e) {
					console.error('Passkey registration error:', e);
					console.error('Error name:', e.name);
					console.error('Error message:', e.message);
					console.error('Full error:', JSON.stringify(e, Object.getOwnPropertyNames(e)));

					// User-friendly error messages
					let msg = 'Failed to add passkey';
					if (e.name === 'NotAllowedError') {
						msg = 'Registration cancelled or timed out';
					} else if (e.name === 'NotSupportedError') {
						msg = 'Passkeys not supported in this browser';
					} else if (e.message) {
						msg = e.message;
					}
					alert(msg);
					btn.disabled = false;
					btn.textContent = 'Add New Passkey';
				}
				});
			}
		}
