include ./field.pug
include ../header.pug
include ../mixins/loadingSpinner.pug

+dialog()
	#signin.w-full.flex.flex-col.items-center.gap-2
		h2.text-xl.font-extrabold.mb-4 Log In
		form.contents(
			hx-post="/auth/login"
			hx-trigger="submit"
			hx-target="#loginError"
			hx-swap="innerHTML")
			+textInput("Email", "email")(autocomplete="username")
			+passwordInput("Password", "password")(autocomplete="current-password")
			.flex.gap-2.items-center
				button.primary(type="submit" hx-disabled-elt="this")
					span Log In
					+loadingSpinner()
				a.link(
					hx-get="/dialog/auth/signup"
					hx-swap="outerHTML"
					hx-target="#signin"
				) Sign Up

			span#loginError.text-red-600.font-semibold.text-sm(role="alert" aria-live="polite")

		.flex.items-center.my-4(class="w-full")
			.flex-grow.h-px.bg-gray-800
			span.text-xs.text-slate-11.font-normal.mx-4 OR
			.flex-grow.h-px.bg-gray-800

		if googleURL
			a(href=googleURL alt='Sign in with Google')
				img(src='/google-signin-button.svg')

		if facebookURL
			a(href=facebookURL alt='Sign in with Facebook')
				img(src='/facebook-signin-button.svg')

		button#passkeyLoginBtn(type="button" style="background: none; border: none; padding: 0; cursor: pointer;")
			img(src='/passkey-signin-button.svg')

		a.link(
			hx-get="/dialog/auth/forgot-password"
			hx-target="#signin") Forgot password...

		script(type="module").
			// Passkey login button handler
			import { startAuthentication } from 'https://esm.sh/@simplewebauthn/browser@13.2.2';

			const btn = document.getElementById('passkeyLoginBtn');
			const errorEl = document.getElementById('loginError');

			if (btn) {
				// Check WebAuthn support
				if (!window.PublicKeyCredential) {
					btn.disabled = true;
					btn.textContent = 'Passkeys not supported';
				} else {
					btn.addEventListener('click', async () => {
						try {
							btn.disabled = true;
							const originalText = btn.textContent;
							btn.textContent = 'Authenticating...';
							errorEl.textContent = '';

							// Get authentication options
							const optRes = await fetch('/auth/passkey/login/options', { method: 'POST' });
							if (!optRes.ok) throw new Error('Server error');
							const opts = await optRes.json();

							// Start authentication
							const credential = await startAuthentication(opts);

							// Verify with server
							const verRes = await fetch('/auth/passkey/login/verify', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(credential)
							});

							if (verRes.ok) {
								window.location.href = '/';
							} else {
								throw new Error('Authentication failed');
							}
						} catch (error) {
							console.error('Passkey login error:', error);

							// User-friendly error messages
							let msg = 'Passkey authentication failed';
							if (error.name === 'NotAllowedError') {
								msg = 'Authentication cancelled or timed out';
							} else if (error.name === 'NotSupportedError') {
								msg = 'Passkeys not supported in this browser';
							} else if (error.message) {
								msg = error.message;
							}

							if (errorEl) errorEl.textContent = msg;
							btn.disabled = false;
							btn.textContent = 'Login with Passkey';
						}
					});
				}
			}
